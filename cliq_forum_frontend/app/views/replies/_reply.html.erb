<% 
   current_user_id = current_user ? (current_user[:id] || current_user["id"]).to_i : nil
   reply_user_id = reply["user"]["id"].to_i
   is_mine = current_user_id == reply_user_id
   is_deleted = reply["is_deleted"] == true
   
   created_at_time = Time.parse(reply['created_at'])
   updated_at_time = reply['updated_at'] ? Time.parse(reply['updated_at']) : created_at_time
   # Add variance buffer (Wait 5 seconds before counting as an edit to handle db timestamps diffs properly)
   is_edited = !is_deleted && (updated_at_time - created_at_time > 5)

   # Safe ID retrieval
   c_id = local_assigns[:cliq_id] || (@cliq ? @cliq["id"] : params[:cliq_id])
   p_id = local_assigns[:post_id] || (@post ? @post["id"] : params[:post_id])
   
   card_classes = ["card", "mb-3", "border-0"]
   if is_deleted
     card_classes << "bg-light opacity-75"
   else
     card_classes << (is_mine ? "bg-white border-start border-3 border-primary shadow-sm" : "bg-light")
   end
%>
<div class="<%= card_classes.join(' ') %>" id="reply-<%= reply['id'] %>" tabindex="-1" <%= 'data-controller="new-item"' if local_assigns[:highlight] %>>
  <div class="card-body p-3">
    <% if !is_deleted && reply["parent"] %>
      <div class="mb-2 pb-2 border-bottom border-light-subtle">
        <a href="#reply-<%= reply['parent']['id'] %>" class="text-decoration-none text-muted small d-flex align-items-center">
          <span class="me-1">â†©</span> Replying to <%= reply["parent"]["user_email"] %>
        </a>
      </div>
    <% end %>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <% if is_deleted %>
         <div class="text-muted small fst-italic">
            <i class="bi bi-trash small me-1"></i> Post deleted
            <span class="mx-1">â€¢</span>
            <%= time_ago_in_words(created_at_time) %> ago
          </div>
      <% else %>
        <div class="d-flex align-items-center gap-2">
          <!-- Avatar placeholder if needed -->
          <div class="fw-bold">
            <%= link_to reply['user']['email'].split('@').first, user_profile_path(reply['user']['id']), class: "text-decoration-none text-dark" %>
          </div>
          <div class="text-muted small">
            â€¢ <%= time_ago_in_words(created_at_time) %> ago
            <% if is_edited %>
               <span class="fst-italic ms-1" title="Edited <%= time_ago_in_words(updated_at_time) %> ago" style="font-size: 0.9em;">(edited)</span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="trix-content">
      <% if is_deleted %>
         <p class="text-muted fst-italic mb-0">[This post has been deleted]</p>
       <% else %>
         <%= sanitize reply['content'] %>
       <% end %>
    </div>
    
    <% unless is_deleted %>
    <div class="mt-3 pt-2 border-top border-light-subtle d-flex align-items-center gap-3">
       <!-- Reply Button (Icon Only) -->
       <button class="btn btn-sm text-secondary p-0 d-flex align-items-center justify-content-center"
               style="width: 32px; height: 32px; border-radius: 50%; background-color: transparent;"
               onmouseover="this.style.backgroundColor='#e9ecef'"
               onmouseout="this.style.backgroundColor='transparent'"
               title="Reply"
               type="button"
               data-action="click->reply-linker#setTarget"
               data-id="<%= reply['id'] %>"
               data-author="<%= reply['user']['email'].split('@').first %>">
         <i class="bi bi-reply-fill fs-5"></i>
       </button>
       
       <% if reply["children"] && reply["children"].any? %>
         <div data-controller="toggle" class="position-relative">
            <button class="btn btn-sm btn-link text-decoration-none text-muted p-0 d-flex align-items-center gap-1"
                    data-action="click->toggle#toggle">
              <span class="small">â¬‡ <%= reply["children"].count %> <%= "reply".pluralize(reply["children"].count) %></span>
            </button>
            
            <div data-toggle-target="content" class="d-none mt-2 p-2 bg-white border rounded shadow-sm position-absolute" style="z-index: 10; min-width: 200px; left: 0;">
              <% reply["children"].each do |child| %>
                <div class="mb-1">
                   <a href="#reply-<%= child['id'] %>" class="text-decoration-none text-dark d-flex align-items-center small">
                     <span class="me-2">ðŸ’¬</span> 
                     <span class="fw-bold"><%= child['user_email'] %></span>
                     <span class="text-muted ms-1">replied</span>
                   </a>
                </div>
              <% end %>
            </div>
         </div>
       <% end %>

       <!-- More Options (Right Aligned) -->
       <div class="dropdown ms-auto">
         <button class="btn btn-sm text-muted p-0 d-flex align-items-center justify-content-center" 
                 type="button" 
                 title="More options"
                 data-bs-toggle="dropdown"
                 style="width: 32px; height: 32px; border-radius: 50%;"
                 onmouseover="this.style.backgroundColor='#e9ecef'"
                 onmouseout="this.style.backgroundColor='transparent'">
           <i class="bi bi-three-dots"></i>
         </button>
         <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
            <li><%= link_to "#", class: "dropdown-item small" do %>
              <i class="bi bi-flag me-2"></i> Report
            <% end %></li>
            
            <% if is_mine %>
              <li><hr class="dropdown-divider"></li>
              <li><%= link_to edit_cliq_post_reply_path(c_id, p_id, reply['id']), class: "dropdown-item small", data: { turbo_stream: true } do %>
                <i class="bi bi-pencil me-2"></i> Edit
              <% end %></li>
              <li><%= link_to cliq_post_reply_path(c_id, p_id, reply['id']), class: "dropdown-item small text-danger", data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this reply?" } do %>
                <i class="bi bi-trash me-2"></i> Delete
              <% end %></li>
            <% end %>
         </ul>
       </div>
    </div>
    <% end %>
  </div>
</div>
